<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#1890FF"><meta name="author" content="粗茶淡饭"><meta name="copyright" content="粗茶淡饭"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>Vue源码之虚拟dom和diff算法（上） | jianの技术空间</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#1890FF"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"indexsarrol.cn","root":"/","title":"习惯尝试，尝试习惯","version":"1.3.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta property="og:type" content="article">
<meta property="og:title" content="Vue源码之虚拟dom和diff算法（上）">
<meta property="og:url" content="https://indexsarrol.cn/2022/04/15/virtualDom-and-diff/index.html">
<meta property="og:site_name" content="jianの技术空间">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415220203679.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415133627012.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415135418566.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415144500575.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415145047553.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415203658950.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415204745853.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415205551369.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415210115723.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415210857688.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415214849569.png">
<meta property="article:published_time" content="2022-04-14T16:00:00.000Z">
<meta property="article:modified_time" content="2022-04-15T14:02:10.717Z">
<meta property="article:author" content="粗茶淡饭">
<meta property="article:tag" content="Vue">
<meta property="article:tag" content="Diff算法">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415220203679.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="粗茶淡饭"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="粗茶淡饭"><span class="site-author-status" title="都进来了，浏览器点个收藏呗！">😘</span></a><div class="site-author-name"><a href="/about/">粗茶淡饭</a></div><a class="site-name" href="/about/site.html">jianの技术空间</a><sub class="site-subtitle">You Complete Me！</sub><div class="site-desciption">戒骄戒躁，言多必失！</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">14</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">13</span></a></div><a class="site-state-item hty-icon-button" href="/albums/" title="相册"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-gallery-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=843696490&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/Indexsarrol" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:843696490@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=355354344" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/1579790" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="我的小伙伴们，快来看看吧" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%99%9A%E6%8B%9FDOM%E5%92%8CDiff%E7%AE%97%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">什么是虚拟DOM和Diff算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9FDOM%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.1.</span> <span class="toc-text">虚拟DOM是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E7%94%A8%E8%99%9A%E6%8B%9FDOM%EF%BC%9F"><span class="toc-number">2.2.</span> <span class="toc-text">为什么我们要用虚拟DOM？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Diff%E7%AE%97%E6%B3%95%E6%98%AF%E4%BB%80%E4%B9%88%E4%BB%A5%E5%8F%8A%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8%E5%AE%83%EF%BC%9F"><span class="toc-number">2.3.</span> <span class="toc-text">Diff算法是什么以及为什么要使用它？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#snabbdom%E7%AE%80%E4%BB%8B%E4%BB%A5%E5%8F%8A%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.</span> <span class="toc-text">snabbdom简介以及测试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFsnabbdom%EF%BC%9F"><span class="toc-number">3.1.</span> <span class="toc-text">什么是snabbdom？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.2.</span> <span class="toc-text">测试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">3.2.1.</span> <span class="toc-text">安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAwebpack"><span class="toc-number">3.3.</span> <span class="toc-text">搭建webpack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">h函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">4.1.</span> <span class="toc-text">h函数是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="toc-number">4.2.</span> <span class="toc-text">h函数如何使用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%94%E7%A4%BAh%E5%87%BD%E6%95%B0%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E4%B8%8A%E6%A0%91"><span class="toc-number">4.3.</span> <span class="toc-text">演示h函数使用以及上树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0%E6%9B%B4%E5%A4%9A%E5%86%99%E6%B3%95"><span class="toc-number">4.4.</span> <span class="toc-text">h函数更多写法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%89%88%E7%9A%84h-%E5%87%BD%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">如何手写一个简单版的h()函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vnode%E5%87%BD%E6%95%B0"><span class="toc-number">5.1.</span> <span class="toc-text">vnode函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#h%E5%87%BD%E6%95%B0-1"><span class="toc-number">5.2.</span> <span class="toc-text">h函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%93%E9%AA%8CDiff%E7%AE%97%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">体验Diff算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Diff%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94patch%E5%87%BD%E6%95%B0"><span class="toc-number">7.</span> <span class="toc-text">Diff算法——patch函数</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://indexsarrol.cn/2022/04/15/virtualDom-and-diff/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="粗茶淡饭"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="jianの技术空间"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Vue源码之虚拟dom和diff算法（上）</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2022-04-15 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-15T00:00:00+08:00">2022-04-15</time></div><span class="leancloud_visitors" id="/2022/04/15/virtualDom-and-diff/" data-flag-title="Vue源码之虚拟dom和diff算法（上）"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读次数"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/Vue/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Vue</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/Vue/" style="--text-color:#4fc08d"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Vue</span></a><a class="tag" href="/tags/Diff%E7%AE%97%E6%B3%95/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Diff算法</span></a></span></div><div class="post-author"><span class="author-name">Indexsarrol</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#1890FF;"><p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415220203679.png" alt="image-20220415220203679" loading="lazy"></p>
<a id="more"></a>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着前端框架的发展，现在只停留会使用这些框架上是远远不够的，可以这么说，连面试可能都没法通过，所以现在的面试就要求我们不仅仅要会使用，而且要熟知其原理。虽然在工作当中，我们可能不会去要求我们去手写一些底层原理，但是懂了其原理，我们就可以快速的去定位问题，从而提升我们的工作效率，同时也能锻炼自己的编程能力。虚拟DOM和Diff算法这两个东西现在基本上每个前端同学都听过，而且或多或少的看过一些文章。但是大部分都处于一知半解的状态。懂，但又不是完全懂了。所以我最近也是有点苦恼，然后找了相关的资料狠狠的补习了一下。在这里也当作我的一个笔记吧。</p>
<h2 id="什么是虚拟DOM和Diff算法"><a href="#什么是虚拟DOM和Diff算法" class="headerlink" title="什么是虚拟DOM和Diff算法"></a>什么是虚拟DOM和Diff算法</h2><h3 id="虚拟DOM是什么？"><a href="#虚拟DOM是什么？" class="headerlink" title="虚拟DOM是什么？"></a>虚拟DOM是什么？</h3><p>虚拟DOM，乍听感觉这个词非常牛逼，非常高大上。我们可以把词给拆开来看，“虚拟”和“<code>DOM</code>”，<code>DOM</code>这个词我们肯定不会陌生，他就是文本对象模型，我们不必再去赘述。那么怎么去理解“虚拟”这个词呢，假的！是“虚拟”可以理解为假的，不真实的，那么我们就可以将虚拟DOM这个词理解为不是真实的DOM——利用js对象来表示真实DOM。也就相当于说虚拟DOM就是真实DOM节点的一个js对象的映射。我们可以参考以下的图片:</p>
<p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415133627012.png" alt="image-20220415133627012" loading="lazy"></p>
<p>我们从上图可以得知，真实DOM的节点都会对应一个虚拟DOM的对象。从而得出结论：</p>
<blockquote>
<p>虚拟DOM就是真实DOM的js对象的一个描述。</p>
</blockquote>
<h3 id="为什么我们要用虚拟DOM？"><a href="#为什么我们要用虚拟DOM？" class="headerlink" title="为什么我们要用虚拟DOM？"></a>为什么我们要用虚拟DOM？</h3><p>在<code>jquery</code>时代，我们大家都知道，我们是通过操作真实DOM去处理页面的节点进行增删改的操作，可能对于我们来说就是一瞬间的事，但是对于计算机来说，可能需要进行成千上万次的操作，无疑这样是非常浪费性能的，这时候我们就引进了虚拟DOM，将需要更新的节点通过Diff算法进行最小化的更新，从而不再去操作真实DOM，仅对需要变化的节点进行更新操作，大大的节省的性能。</p>
<h3 id="Diff算法是什么以及为什么要使用它？"><a href="#Diff算法是什么以及为什么要使用它？" class="headerlink" title="Diff算法是什么以及为什么要使用它？"></a>Diff算法是什么以及为什么要使用它？</h3><p>接下来，我们再聊聊Diff算法，那么什么是Diff算法呢。我们这里先直接给Diff算法下个定义：</p>
<blockquote>
<p>简单来说Diff算法就是在虚拟DOM树从上至下进行同层比对，找出不同的地方进行最小量化的更新，从而间接更新真实DOM</p>
</blockquote>
<p>我们怎么去理解Diff算法呢？这里举一个很简单的例子——装修。加入我现在有一个装修好的房子，现在呢，我想把主卧的床和客厅的沙发给换掉，那我们是不是直接把原来的沙发和床直接丢弃，然后弄个新的就可以了。那么Diff算法就是这么一个逻辑，</p>
<p>它会先去全局扫描一下，比较我变更前的床和沙发是否一样，如果不一样就直接将新的沙发和床把原来的给替换掉。如果一样的地方，比如电视机，没有变化，那就原封不动。从而节省的很多人力。放到程序中看，如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415135418566.png" alt="image-20220415135418566" loading="lazy"></p>
<p>在这里我们可以看到，我们在新的DOM元素上添加了一个新的<code>&lt;span&gt;</code>标签以及<code>&lt;li&gt;</code>标签，那么Diff算法就可以进行精细化的比较，从而实现最小化的更新。</p>
<h2 id="snabbdom简介以及测试环境搭建"><a href="#snabbdom简介以及测试环境搭建" class="headerlink" title="snabbdom简介以及测试环境搭建"></a>snabbdom简介以及测试环境搭建</h2><h3 id="什么是snabbdom？"><a href="#什么是snabbdom？" class="headerlink" title="什么是snabbdom？"></a>什么是snabbdom？</h3><p><code>snabbdom</code>是瑞典语的一个单词，意为“速度”，而我们熟知的<code>Vue.js</code>，其源码也借鉴了<code>snabbdom</code>，可以说<code>snabbdom</code>是虚拟DOM的鼻祖。</p>
<h3 id="测试环境搭建"><a href="#测试环境搭建" class="headerlink" title="测试环境搭建"></a>测试环境搭建</h3><p>想要知道其内部怎么实现的，我们就需要自己手动的去搭建一个测试环境来进行代码的调试，以及后面手写代码。首先创建文件夹，命名为<code>study-snabbdom</code>，然后执<code>行npm init -y</code></p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><code>snabbdom</code>有很多版本，为了方便，我们就以2.1.0的版本作为测试环境中的版本：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> snabbdom --save</code></pre>
<h3 id="搭建webpack"><a href="#搭建webpack" class="headerlink" title="搭建webpack"></a>搭建webpack</h3><p>这里我就不在多赘述了，想了解的可直接前往<code>webpack</code><a target="_blank" rel="noopener" href="https://webpackjs.com/">官网</a>进行文档查阅。在这里仅把配置项放出来。</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    publicPath<span class="token operator">:</span> <span class="token string">'dist'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'bundle.js'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  devtool<span class="token operator">:</span> <span class="token string">'cheap-module-source-map'</span><span class="token punctuation">,</span> 
  devServer<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
    contentBase<span class="token operator">:</span> <span class="token string">'www'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>


<h2 id="h函数"><a href="#h函数" class="headerlink" title="h函数"></a>h函数</h2><h3 id="h函数是什么？"><a href="#h函数是什么？" class="headerlink" title="h函数是什么？"></a>h函数是什么？</h3><p>什么是<code>h</code>函数呢，简言之：</p>
<blockquote>
<p>就是用来生成虚拟节点（<code>vnode</code>）的一个方法。</p>
</blockquote>
<h3 id="h函数如何使用？"><a href="#h函数如何使用？" class="headerlink" title="h函数如何使用？"></a>h函数如何使用？</h3><p>比如我们可以这么去调用<code>h</code>函数:</p>
<pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> props<span class="token operator">:</span> <span class="token punctuation">&#123;</span> href<span class="token operator">:</span> <span class="token string">'https://www.baidu.com'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'百度'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这样我们就能得到这样的一个虚拟节点：</p>
<pre class="language-none"><code class="language-none">&#123;
	sel: &#39;a&#39;, &#x2F;&#x2F; 选择器
	data: &#123; &#x2F;&#x2F; 相关属性
		props: &#123;
			href: &#39;https:&#x2F;&#x2F;www.baidu.com&#39;
		&#125;
	&#125;,
	text: &#39;百度&#39;, &#x2F;&#x2F; 标签内文本内容
&#125;</code></pre>
<p>那么在页面上，他就表示一个真实的A标签的节点</p>
<pre class="language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://www.baidu.com<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>百度<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span></code></pre>
<p>我们通过上面可以知道，<code>h</code>函数是负责生成一个虚拟节点的方法，那么，虚拟节点里面都有哪些属性呢？</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
	<span class="token property">"sel"</span><span class="token operator">:</span> <span class="token string">"div"</span><span class="token punctuation">,</span> <span class="token comment">// 选择器</span>
	<span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 属性样式类名等</span>
    <span class="token property">"text"</span><span class="token operator">:</span> '<span class="token number">12345</span>'<span class="token punctuation">,</span> <span class="token comment">// 文本内容</span>
    <span class="token property">"children"</span><span class="token operator">:</span> undefined<span class="token punctuation">,</span> <span class="token comment">// 子节点</span>
    <span class="token property">"elm"</span><span class="token operator">:</span> undefined<span class="token punctuation">,</span> <span class="token comment">// 真实DOM节点</span>
    <span class="token property">"key"</span><span class="token operator">:</span> undefined <span class="token comment">// 唯一值</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="演示h函数使用以及上树"><a href="#演示h函数使用以及上树" class="headerlink" title="演示h函数使用以及上树"></a>演示h函数使用以及上树</h3><p>在刚刚搭建的环境中，我们在<code>index.js</code>文件中，导入<code>snabbdom</code>相应的模块：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init<span class="token punctuation">,</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> props<span class="token operator">:</span> <span class="token punctuation">&#123;</span> href<span class="token operator">:</span> <span class="token string">'https://www.baidu.com'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'百度'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>这是我们可以看到控制台上面输出了一个js对象：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415144500575.png" alt="image-20220415144500575" loading="lazy"></p>
<p>那么虚拟节点有了，我们怎么去将这个节点渲染到页面上面呢？这时候我们就要调用<code>snabbdom</code>中的<code>patch</code>函数，来帮助我们完成上树操作：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init<span class="token punctuation">,</span> propsModule<span class="token punctuation">,</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>propsModule<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> props<span class="token operator">:</span> <span class="token punctuation">&#123;</span> href<span class="token operator">:</span> <span class="token string">'https://www.baidu.com'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'百度'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> ducument<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>我们打开页面就可以看到如下：</p>
<img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415145047553.png" alt="image-20220415145047553" style="zoom: 67%;" / loading="lazy">

<p>这样我们就相当于上树了，并且<code>href</code>属性内的链接是可以点击的。</p>
<h3 id="h函数更多写法"><a href="#h函数更多写法" class="headerlink" title="h函数更多写法"></a>h函数更多写法</h3><p>在上面我们说过<code>h</code>函数的一些简单的用法，这里我们要介绍一下<code>h</code>函数的新用法——嵌套，话不多说，直接上代码:</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
	<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'牛奶'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'咖啡'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'可乐'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre>
<p>那么以上代码，转换成虚拟DOM就变成这样:</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token punctuation">&#123;</span>
	sel<span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
	data<span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
	children<span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">&#123;</span> set<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'牛奶'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> set<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'咖啡'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
		<span class="token punctuation">&#123;</span> set<span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token string">'可乐'</span> <span class="token punctuation">&#125;</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>我们的<code>h</code>函数，其内部实现了函数的重载，所以参数传递的方式多种多样，例如以下的写法都是可以的：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span> <span class="token comment">// ===> &#123; sel: 'div', text: undefined, children: undefined &#125;</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'我是div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ===>  &#123; sel: 'div', text: '我是div', children: undefined &#125;</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ===>  &#123; sel: 'div', text: undefined, children: [] &#125;</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ===>  &#123; sel: 'div', text: undefined, children: [&#123; sel: undefind, text: undefined, children: undefined &#125;] &#125;</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token string">'我是内部的盒子'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ===>  &#123; sel: 'div', text: undefined, children: [&#123; sel: 'div', text: '我是内部的盒子', children: undefined &#125;]</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'12354'</span><span class="token punctuation">)</span> <span class="token comment">// ===>  &#123; sel: 'div', data: &#123;&#125;, text: '12354', children: undefined &#125;</span></code></pre>
<p>足以看出，h函数的使用是非常的灵活！</p>
<h2 id="如何手写一个简单版的h-函数"><a href="#如何手写一个简单版的h-函数" class="headerlink" title="如何手写一个简单版的h()函数"></a>如何手写一个简单版的h()函数</h2><p>由于<code>snabbdom</code>源码内的h函数，实现了函数重载，为了方便，这里我们统一采用传入三个参数的方式进行实现。那我们就开始吧！我们先观察一下这个方法的返回值都是一个对象的形式，而且固定，所以我们可以把返回的对象封装为一个函数<code>vnode</code>：</p>
<h3 id="vnode函数"><a href="#vnode函数" class="headerlink" title="vnode函数"></a>vnode函数</h3><p><code>vnode</code>函数传入选择器(sel)、数据项(data)、文本(text)、子节点(children)，真实DOM节点(elm)返回一个新的虚拟DOM对象，新建一个<code>vnode.js</code>文件：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token comment">// vnode.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">vnode</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> text<span class="token punctuation">,</span> elm</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> data<span class="token punctuation">.</span>key <span class="token operator">?</span> data<span class="token punctuation">.</span>key <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// 查询数据项中是否有key</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        sel<span class="token punctuation">,</span>
        data<span class="token punctuation">,</span>
        children<span class="token punctuation">,</span>
        text<span class="token punctuation">,</span>
        elm<span class="token punctuation">,</span>
        key
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="h函数-1"><a href="#h函数-1" class="headerlink" title="h函数"></a>h函数</h3><p>首先，新建一个名为<code>h.js</code>的函数，并且导入<code>vnode.js</code>，我们在一开始也说过，只实现三个参数的方法。分别是以下三种：</p>
<pre class="language-none"><code class="language-none">h(&#39;div&#39;, &#123;&#125;, &#39;文本&#39;);
h(&#39;div&#39;, &#123;&#125;, []);
h(&#39;div&#39;, &#123;&#125;, h(&#39;div&#39;));</code></pre>
<p>代码如下：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> vnode <span class="token keyword">from</span> <span class="token string">'./vnode.js'</span><span class="token punctuation">;</span>

<span class="token comment">// 判断是否为文本类型</span>
<span class="token keyword">function</span> <span class="token function">isText</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'string '</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 判断是否为子节点数组类型</span>
<span class="token keyword">function</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 判断是否为对象且包含sel属性</span>
<span class="token keyword">function</span> <span class="token function">isObjectAndExitSel</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>sel
<span class="token punctuation">&#125;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1.判断当前传入参数是否为3个，如果不是直接报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'参数个数必须为3个!'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 2.判断c参数是文本还是children</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isText</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 2.1如果是文本类型的节点，则直接返回vnode函数</span>
        <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 2.2 如果c是数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObjectAndExitSel</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'传入的数组有一项不是h函数'</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
            children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isObjectAndExitSel</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 2.3 如果是h函数，则被认为是单纯的对象</span>
        <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">vnode</span><span class="token punctuation">(</span>sel<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 以上条件全部不满足</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'第三个参数类型不满足要求'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h2 id="体验Diff算法"><a href="#体验Diff算法" class="headerlink" title="体验Diff算法"></a>体验Diff算法</h2><p>我们在上述说到了创建虚拟DOM节点，那么我们是怎么通过虚拟节点创建出真实DOM节点的并显示到页面上的呢？我们先来看官方的<code>snabbdom</code>，他是通过<code>patch</code>函数将虚拟节点处理成真实DOM并渲染到页面上的，对于这点，我们上述也说过。但那种情况是第一次页面加载时通过调用<code>patch</code>函数上树的，那么我们怎么去体现对比呢？看一下接下来的例子：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init<span class="token punctuation">,</span> propsModule<span class="token punctuation">,</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>propsModule<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一次上树</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>此时页面会出现四个<code>&lt;li&gt;&lt;/li&gt;</code>标签，元素内容分别是A、B、C、D。这时，我们给页面添加一个按钮，同时创建另一个虚拟DOM，当点击按钮时，我们让<code>patch</code>函数重新执行，然后传入<code>vnode1</code>、<code>vnode2</code>，代码如下：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init<span class="token punctuation">,</span> propsModule<span class="token punctuation">,</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>propsModule<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一次上树</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建vnode2</span>
<span class="token keyword">const</span> vnode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span>，
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取按钮元素</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>vnode1<span class="token punctuation">,</span> vnode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>此时打开浏览器之后，页面先是展示A、B、C、D，当我们点击按钮时，页面就更新为了A、B、C、D、E。这样就可以获取到最新的DOM，然而这个变化不能说明什么，它真正牛叉的地方并不是这里，而是Diff算法会对比<code>vnode1</code>、<code>vnode2</code>发现在末尾出多了一个E，然后将E给添加上，剩余的A、B、C、D保持不动，那怎么去验证这个说法呢？我们可以打开控制台——元素，然后选取到<code>&lt;li&gt;&lt;/li&gt;</code>标签内容A，将其改为’AAAA’，如果当我们点按钮时，AAAA没有变为A，则说明Diff是最小量更新，也就是没有更新没变化的位置，修改如下图：</p>
<img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415203658950.png" alt="image-20220415203658950" style="zoom: 67%;" / loading="lazy">

<p>当我们点击按钮有时，发现新增加了一个<code>&lt;li&gt;E&lt;/li&gt;</code>的标签，同时我们刚刚修改的AAAA还是存在的，这就说明，Diff算法采用的最小量更新，如下图所示：</p>
<img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415204745853.png" alt="image-20220415204745853" style="zoom:67%;" / loading="lazy">

<p>这时候我们再来玩会这个东西，这玩意有这么智能吗？刚才我们在末尾追加了这个E，如果我们在开头加呢？会发生什么？我们修改一下代码：</p>
<pre class="language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> init<span class="token punctuation">,</span> propsModule<span class="token punctuation">,</span> h <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'snabbdom'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>propsModule<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vnode1 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 第一次上树</span>
<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建vnode2</span>
<span class="token keyword">const</span> vnode2 <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'E'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取按钮元素</span>
<span class="token keyword">const</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>vnode1<span class="token punctuation">,</span> vnode2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>我们打开控制台后，发现页面上有E、A、B、C、D五个元素，那么他们也是采用最小化更新吗？我们还是用刚才的那种方法试一试，这里为了方便看的清楚，我们把先前的4个元素的内容都改变一下，这是我们再点击按钮，却得到了不可思议的结果。如下：</p>
<img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415205551369.png" alt="image-20220415205551369" style="zoom:67%;" / loading="lazy">



<p>结果为什么是这样呢？这里其实Diff算法内部做比较的时候，没有找到key值，所以它认为这几个节点是完全不用的，所以采用全覆盖的方式。就得到了这种结果，这也是我们在循环遍历节点的时候为什么要加上key值的原因，是不是有一种恍然大悟的感觉。我们在这里加上key之后，再来看看：</p>
<img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415210115723.png" alt="image-20220415210115723" style="zoom:67%;" / loading="lazy">

<p>加上key值之后，我们可以看到Diff算法帮助我们又进行了一次更新，这次更新并没有全部更新， 只更新了一个节点——E。如果我们没有添加key的话，其实diff默认是将节点E放在末尾的，然后将A改为E，B改为A…一直下去：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415210857688.png" alt="image-20220415210857688" loading="lazy"></p>
<p>通过以上种种的实验，我们可以得到几点结论：</p>
<ol>
<li>Diff的最小量更新的前提是key，key是该节点的唯一标识，告诉Diff算法，在更改前后它们是同一个节点；</li>
<li>只有是同一个虚拟节点，才会进行最小量更新，否则就直接暴力拆除旧的、插入新的。那么如果判断是否为同一个虚拟节点呢？答案就是选择器相同，且key相同；</li>
<li>只进行同层比较，不会跨层比较。</li>
</ol>
<h2 id="Diff算法——patch函数"><a href="#Diff算法——patch函数" class="headerlink" title="Diff算法——patch函数"></a>Diff算法——patch函数</h2><p>当我们去研究<code>snabbdom</code>这个库的时候，发现DIff算法是在<code>patch</code>函数种完成的。<code>patch</code>函数则是通过<code>init</code>函数返回出来的，由于<code>init</code>函数跟<code>Diff</code>算法没有多大关系，我们在这里就不做过多解释。那么具体在<code>patch</code>函数中，Diff到底做了些什么呢？我们一步一步去看，首先，<code>patch</code>函数有两个参数<code>oldVnode</code>和 <code>newVnode</code>，然后针对新旧节点进行比较。流程图如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/image-20220415214849569.png" alt="image-20220415214849569" loading="lazy"></p>
<p>由流程图，我们可以得知，当我们去调用<code>patch</code>函数时，内部会执行以下几个步骤。</p>
<pre><code>1. 判断旧节点是否为虚拟节点，如果不是虚拟节点，则先将该节点转换成虚拟节点。其实这里不难理解，只有大家都是虚拟节点的时候才方便比较，毕竟js对象的比较相较于真实DOM可好比较太多了；
1. 如果新旧节点都为虚拟节点，则判断新旧虚拟节点是否为同一个节点，如果为同一个节点，则进行深层次的比较。如果不是，则直接把旧节点删除，将新节点直接插入。</code></pre>
<p>未完待续…</p>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="打赏" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">觉得不错？给个关（zan）注（zhu）呗！.</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/ali-pay-code.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/ali-pay-code.png" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/wechat-pay-code.png"><img loading="lazy" src="https://cdn.jsdelivr.net/gh/Indexsarrol/image/blogs/wechat-pay-code.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Indexsarrol</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://indexsarrol.cn/2022/04/15/virtualDom-and-diff/" title="Vue源码之虚拟dom和diff算法（上）">https://indexsarrol.cn/2022/04/15/virtualDom-and-diff/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/04/08/react-redux/" rel="next" title="都2021年了，你还不会Redux？"><span class="post-nav-text">都2021年了，你还不会Redux？</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>欢迎使用Valine评论系统</span><br></div><div id="valine-container"></div><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function initValine() {
  const valineConfig = {"enable":true,"appId":"yHy5QtvANleKKb3vtYuN4eUY-MdYXbMMI","appKey":"vFNzith4BlgLv5TI1wlnvVu4","placeholder":"写的不错？给个好评？","avatar":"robohash","pageSize":10,"visitor":true,"highlight":true,"recordIP":true,"enableQQ":true,"requiredFields":["nick","mail"],"el":"#valine-container","lang":"zh-cn"}
  valineConfig.path = window.location.pathname
  new Valine(valineConfig)
}
setTimeout(initValine, 800)</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">皖ICP备2021000236</a></div><div class="copyright"><span>&copy; 2020 – 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> 粗茶淡饭</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.3.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.3.0</span></div><div class="live_time"><span>本空间已经运行了</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  window.setTimeout(blog_live_time, 1000);
  const start = new Date('2020-12-23T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#1890FF" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div id="local-search-result"></div></div></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":80,"vOffset":-50},"mobile":{"show":false},"dialog":{"enable":true,"hitokoto":true},"log":false,"tagMode":false});</script></body></html>